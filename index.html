<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ’• Má»i ngÆ°á»i yÃªu Ä‘i chÆ¡i (Cáº§u Giáº¥y)</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a3b;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --stroke: rgba(255,255,255,.16);
      --shadow: 0 20px 70px rgba(0,0,0,.45);
      --radius: 22px;
      --accent: #7c5cff;
      --accent2:#2de2e6;
      --accent3:#ff4d9d;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(1100px 600px at 15% 20%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 80% 35%, rgba(45,226,230,.20), transparent 55%),
        radial-gradient(900px 550px at 55% 85%, rgba(255,77,157,.15), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    #bg{
      position:fixed;
      inset:0;
      z-index:-3;
      display:block;
    }

    .blob{
      position:fixed;
      width:540px;
      height:540px;
      border-radius: 60% 40% 55% 45% / 55% 45% 60% 40%;
      filter: blur(40px);
      opacity:.55;
      z-index:-2;
      mix-blend-mode:screen;
      animation: blobFloat 12s ease-in-out infinite;
      pointer-events:none;
    }
    .blob.b1{
      left:-170px; top:-140px;
      background: radial-gradient(circle at 30% 30%, rgba(124,92,255,.85), rgba(124,92,255,0));
      animation-delay: -2s;
    }
    .blob.b2{
      right:-210px; top:50px;
      width:610px; height:610px;
      background: radial-gradient(circle at 40% 40%, rgba(45,226,230,.80), rgba(45,226,230,0));
      animation-delay: -6s;
    }
    .blob.b3{
      left:20%; bottom:-260px;
      width:720px; height:720px;
      background: radial-gradient(circle at 40% 40%, rgba(255,77,157,.55), rgba(255,77,157,0));
      animation-delay: -9s;
    }

    @keyframes blobFloat{
      0%   { transform: translate(0,0) scale(1) rotate(0deg); border-radius: 60% 40% 55% 45% / 55% 45% 60% 40%; }
      33%  { transform: translate(25px,20px) scale(1.03) rotate(6deg); border-radius: 45% 55% 40% 60% / 55% 45% 40% 60%; }
      66%  { transform: translate(-20px,30px) scale(0.98) rotate(-6deg); border-radius: 55% 45% 60% 40% / 40% 60% 55% 45%; }
      100% { transform: translate(0,0) scale(1) rotate(0deg); border-radius: 60% 40% 55% 45% / 55% 45% 60% 40%; }
    }

    .screen{
      display:none;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding:28px 16px 60px;
      position:relative;
    }
    .screen.active{ display:flex; }

    .welcome-card, .invite-card{
      max-width:600px;
      width:100%;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:48px 32px;
      text-align:center;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    .welcome-card::before, .invite-card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 400px at 50% 0%, rgba(124,92,255,.15), transparent 60%),
                  radial-gradient(500px 350px at 50% 100%, rgba(255,77,157,.12), transparent 60%);
      z-index:0;
      pointer-events:none;
    }

    .welcome-card > *, .invite-card > *{ position:relative; z-index:1; }

    .emoji-big{
      font-size: 80px;
      margin-bottom:24px;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float{
      0%, 100%{ transform: translateY(0); }
      50%{ transform: translateY(-12px); }
    }

    .welcome-title{
      font-size: clamp(28px, 5vw, 42px);
      margin:0 0 16px;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #fff, rgba(255,255,255,.7));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-text{
      font-size: 16px;
      color: var(--muted);
      line-height:1.6;
      margin:0 0 32px;
    }

    .invite-title{
      font-size: clamp(24px, 4.5vw, 36px);
      margin:0 0 20px;
      letter-spacing: -0.01em;
      line-height:1.3;
    }

    .invite-subtitle{
      font-size: 18px;
      color: var(--muted);
      line-height:1.7;
      margin:0 0 26px;
    }

    .hearts{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-bottom:32px;
      font-size: 24px;
    }
    .hearts span{ animation: heartbeat 1.5s ease-in-out infinite; }
    .hearts span:nth-child(1){ animation-delay: 0s; }
    .hearts span:nth-child(2){ animation-delay: 0.2s; }
    .hearts span:nth-child(3){ animation-delay: 0.4s; }
    @keyframes heartbeat{
      0%, 100%{ transform: scale(1); }
      25%{ transform: scale(1.2); }
      50%{ transform: scale(1); }
    }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:14px 32px;
      border-radius: 14px;
      cursor:pointer;
      transition:.2s ease;
      font-weight: 650;
      letter-spacing: .01em;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      font-size: 16px;
      justify-content:center;
    }
    .btn:hover{ transform: translateY(-2px); background: rgba(255,255,255,.12); }
    .btn:active{ transform: translateY(0px) scale(.98); }
    .btn.primary{
      border-color: rgba(255,77,157,.55);
      background: linear-gradient(135deg, rgba(255,77,157,.35), rgba(124,92,255,.25));
      box-shadow: 0 12px 30px rgba(255,77,157,.25);
    }

    .question-container{ max-width:820px; width:100%; position:relative; }
    .progress-bar{ margin-bottom:32px; display:flex; gap:8px; justify-content:center; }
    .progress-dot{
      width:12px; height:12px; border-radius:50%;
      background: rgba(255,255,255,.2);
      transition:.3s ease;
    }
    .progress-dot.active{
      background: var(--accent3);
      box-shadow: 0 0 12px rgba(255,77,157,.6);
    }
    .progress-dot.done{ background: var(--accent2); }

    .question-card{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:40px 32px;
      text-align:center;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
      display:none;
      animation: slideIn 0.4s ease-out;
    }
    .question-card.active{ display:block; }
    @keyframes slideIn{
      from{ opacity:0; transform: translateY(20px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .question-card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 400px at 50% 0%, rgba(124,92,255,.15), transparent 60%),
                  radial-gradient(500px 350px at 50% 100%, rgba(255,77,157,.12), transparent 60%);
      z-index:0; pointer-events:none;
    }
    .question-card > *{ position:relative; z-index:1; }

    .question-emoji{
      font-size: 64px; margin-bottom:20px;
      display:inline-block;
      animation: float 3s ease-in-out infinite;
    }
    .question-text{
      font-size: clamp(22px, 4vw, 32px);
      margin:0 0 12px;
      letter-spacing: -0.01em;
    }
    .question-hint{
      font-size: 15px;
      color: var(--muted);
      margin:0 0 28px;
    }

    .options-grid{ display:grid; gap:14px; margin-bottom:8px; }
    .options-grid.cols-3{ grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .options-grid.cols-2{ grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

    .option-card{
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 2px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding:22px 18px;
      cursor:pointer;
      transition:.25s ease;
      position:relative;
      overflow:hidden;
      text-align:left;
    }
    .option-card:hover{
      transform: translateY(-4px) scale(1.01);
      border-color: rgba(255,255,255,.25);
    }
    .option-card.selected{
      border-color: var(--accent3);
      background: linear-gradient(135deg, rgba(255,77,157,.2), rgba(124,92,255,.15));
      box-shadow: 0 8px 24px rgba(255,77,157,.3);
    }

    .option-icon{ font-size: 34px; margin-bottom:10px; display:block; }
    .option-title{ font-size: 16px; font-weight: 650; margin:0 0 4px; }
    .option-desc{ font-size: 13px; color: var(--muted); margin:0; line-height:1.45; }

    .vibe-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap:12px;
      margin-bottom:10px;
    }
    .vibe-card{
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 2px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding:18px 14px;
      cursor:pointer;
      transition:.25s ease;
      text-align:center;
    }
    .vibe-card:hover{ transform: translateY(-3px); border-color: rgba(255,255,255,.22); }
    .vibe-card.selected{
      border-color: var(--accent2);
      background: linear-gradient(135deg, rgba(45,226,230,.15), rgba(124,92,255,.1));
      box-shadow: 0 6px 20px rgba(45,226,230,.25);
    }
    .vibe-icon{ font-size: 32px; display:block; margin-bottom:8px; }
    .vibe-label{ font-size: 13px; font-weight: 600; }

    .selected-count{ font-size: 13px; color: var(--muted); margin-top:6px; min-height:18px; }
    .btn-next{ margin-top:16px; }

    .result-container{ max-width:720px; width:100%; }
    .result-card{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:36px 28px;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .result-card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 300px at 30% 0%, rgba(124,92,255,.14), transparent 60%),
        radial-gradient(520px 280px at 85% 20%, rgba(45,226,230,.11), transparent 58%),
        radial-gradient(520px 280px at 50% 110%, rgba(255,77,157,.10), transparent 58%);
      z-index:0; pointer-events:none;
    }
    .result-card > *{ position:relative; z-index:1; }

    .result-header{ text-align:center; margin-bottom:22px; }
    .result-emoji{ font-size: 56px; margin-bottom:12px; }
    .result-title{ font-size: clamp(24px, 4vw, 32px); margin:0 0 6px; letter-spacing:-.01em; }
    .result-subtitle{ font-size: 15px; color: var(--muted); margin:0; }

    .result-content{
      background: rgba(0,0,0,.2);
      border-radius: 16px;
      padding:22px;
      margin-bottom:14px;
    }
    .result-item{ margin-bottom:16px; line-height:1.6; }
    .result-item:last-child{ margin-bottom:0; }
    .result-label{ font-size: 13px; color: var(--muted); margin-bottom:4px; }
    .result-value{ font-size: 16px; font-weight: 600; }
    .result-steps{ margin-top:10px; padding-left:18px; }
    .result-steps li{ margin-bottom:8px; color: var(--muted); font-size: 14px; }

    .result-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:10px;
    }

    .email-box{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .email-input{
      width:min(360px, 100%);
      padding:14px 14px;
      border-radius:14px;
      border:2px solid rgba(255,255,255,.2);
      background:rgba(0,0,0,.3);
      color:#fff;
      font-size:15px;
      outline:none;
    }
    .email-status{
      margin-top:10px;
      text-align:center;
      font-size:13px;
      color: var(--muted);
      min-height:18px;
    }

    .confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 30;
    }
    .confetti i{
      position:absolute;
      width:10px; height:14px;
      border-radius: 4px;
      opacity:.95;
      transform: translateY(-20px) rotate(0deg);
      animation: fall 1.2s linear forwards;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.25));
    }
    @keyframes fall{
      to { transform: translateY(110vh) rotate(320deg); opacity:1; }
    }

    @media (max-width: 600px){
      .options-grid.cols-3, .options-grid.cols-2{ grid-template-columns: 1fr; }
      .vibe-grid{ grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
      .email-box{ flex-direction:column; align-items:stretch; }
    }
  </style>
</head>

<body>
  <canvas id="bg"></canvas>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>
  <div class="confetti" id="confetti"></div>

  <!-- SCREEN 1: Welcome -->
  <div class="screen active" id="screen1">
    <div class="welcome-card">
      <div class="emoji-big">ğŸ’</div>
      <h1 class="welcome-title">Xin chÃ o ThÃ¹y xinh iuuuu cá»§a mÃ¬nh âœ¨</h1>
      <p class="welcome-text">HÃ´m nay trá»i Ä‘áº¹p quÃ¡, mÃ¬nh cÃ³ Ä‘iá»u muá»‘n nÃ³i vá»›i ThÃ¹y...</p>
      <button class="btn primary" onclick="nextScreen(2)">ğŸ’• Tiáº¿p theo nha</button>
    </div>
  </div>

  <!-- SCREEN 2: Invitation -->
  <div class="screen" id="screen2">
    <div class="invite-card">
      <div class="hearts"><span>ğŸ’–</span><span>ğŸ’—</span><span>ğŸ’–</span></div>
      <h2 class="invite-title">ThÃ¹y Æ¡iiii...<br/>Cuá»‘i tuáº§n mÃ¬nh Ä‘i chÆ¡i quanh <b>Cáº§u Giáº¥y</b> nhÃ©? ğŸ¥º</h2>
      <p class="invite-subtitle">MÃ¬nh lÃ m nhanh 1 cÃ¡i â€œmini kháº£o sÃ¡tâ€ Ä‘á»ƒ chá»‘t kÃ¨o Ä‘áº¹p: nháº­p email â†’ chá»n quÃ¡n â†’ chá»n budget â†’ chá»n vibe â†’ chá»n ngÃ y giá» ğŸ˜š</p>
      <button class="btn primary" onclick="nextScreen('email')">â¤ï¸ Okiii, báº¯t Ä‘áº§u nÃ o!</button>
    </div>
  </div>

  <!-- SCREEN 2.5: Email -->
  <div class="screen" id="screenEmail">
    <div class="invite-card">
      <div class="hearts"><span>ğŸ’–</span><span>ğŸ’—</span><span>ğŸ’–</span></div>
      <h2 class="invite-title">Nháº­p email Ä‘á»ƒ mÃ¬nh gá»­i plan cho ThÃ¹y nhaaaaaa ğŸ’Œ</h2>
      <p class="invite-subtitle">
        Nháº­p email cá»§a em.<br/>
        Tá»›i bÆ°á»›c cuá»‘i lÃ  plan sáº½ auto bay vÃ o inbox luÃ´n âœ¨
      </p>

      <div class="email-box">
        <input
          id="receiverEmail"
          class="email-input"
          type="email"
          placeholder="vd: ThuyXinhIuuuu@gmail.com"
          autocomplete="email"
        />
        <button class="btn primary" onclick="saveEmailAndGo()">âœ… Oki, chá»n quÃ¡n</button>
      </div>
      <div class="email-status" id="emailGateStatus"></div>
    </div>
  </div>

  <!-- SCREEN 3: Questions -->
  <div class="screen" id="screen3">
    <div class="question-container">
      <div class="progress-bar">
        <div class="progress-dot active" id="dot1"></div>
        <div class="progress-dot" id="dot2"></div>
        <div class="progress-dot" id="dot3"></div>
        <div class="progress-dot" id="dot4"></div>
      </div>

      <!-- Q1: Pick Cafe -->
      <div class="question-card active" id="q1">
        <div class="question-emoji">â˜•</div>
        <h2 class="question-text">MÃ¬nh háº¹n á»Ÿ quÃ¡n nÃ o nÃ¨?</h2>
        <p class="question-hint">Chá»n 1 quÃ¡n, rá»“i mÃ¬nh dáº¡o há»“ NghÄ©a TÃ¢n nÃ³i chuyá»‡n nha~</p>

        <div class="options-grid cols-3" id="cafeOptions">
          <div class="option-card" data-value="Mequilla Coffee">
            <span class="option-icon">ğŸ«</span>
            <div class="option-title">Mequilla Coffee</div>
            <div class="option-desc">Gá»n gÃ ng, dá»… ngá»“i lÃ¢u, chá»‘t mood nháº¹</div>
          </div>

          <div class="option-card" data-value="Má»™c Coffee">
            <span class="option-icon">ğŸŒ¿</span>
            <div class="option-title">Má»™c Coffee</div>
            <div class="option-desc">Vibe má»™c máº¡c, yÃªn yÃªn Ä‘á»ƒ tÃ¢m sá»±</div>
          </div>

          <div class="option-card" data-value="Taetna Tacos PhÃ¡p">
            <span class="option-icon">ğŸŒ®</span>
            <div class="option-title">Taetna Tacos (PhÃ¡p)</div>
            <div class="option-desc">Ä‚n nháº¹ kiá»ƒu â€œtacosâ€, xong Ä‘i dáº¡o cho tiÃªu bá»›t no</div>
          </div>
        </div>
      </div>

      <!-- Q2: Budget -->
      <div class="question-card" id="q2">
        <div class="question-emoji">ğŸ’°</div>
        <h2 class="question-text">Budget cá»§a hai Ä‘á»©a mÃ¬nh?</h2>
        <p class="question-hint">Chá»n má»©c ngÃ¢n sÃ¡ch thoáº£i mÃ¡i nháº¥t~</p>

        <div class="options-grid cols-3" id="budgetOptions">
          <div class="option-card" data-value="low">
            <span class="option-icon">ğŸƒ</span>
            <div class="option-title">Tiáº¿t kiá»‡m</div>
            <div class="option-desc">0 â€“ 200k/ngÆ°á»i</div>
          </div>
          <div class="option-card" data-value="mid">
            <span class="option-icon">âœ¨</span>
            <div class="option-title">á»”n Ã¡p</div>
            <div class="option-desc">200k â€“ 800k</div>
          </div>
          <div class="option-card" data-value="high">
            <span class="option-icon">ğŸ’</span>
            <div class="option-title">Tá»± thÆ°á»Ÿng</div>
            <div class="option-desc">800k+</div>
          </div>
        </div>
      </div>

      <!-- Q3: Vibes -->
      <div class="question-card" id="q3">
        <div class="question-emoji">ğŸ¨</div>
        <h2 class="question-text">Em muá»‘n vibe nÃ o?</h2>
        <p class="question-hint">Chá»n 1â€“3 vibes em thÃ­ch nháº¥t nhÃ©!</p>

        <div class="vibe-grid" id="vibeOptions">
          <div class="vibe-card" data-value="cafe"><span class="vibe-icon">â˜•</span><div class="vibe-label">Cafe chill</div></div>
          <div class="vibe-card" data-value="anvat"><span class="vibe-icon">ğŸ°</span><div class="vibe-label">Ä‚n nháº¹</div></div>
          <div class="vibe-card" data-value="walk"><span class="vibe-icon">ğŸŒ†</span><div class="vibe-label">Äi dáº¡o</div></div>
          <div class="vibe-card" data-value="deep"><span class="vibe-icon">ğŸ’¬</span><div class="vibe-label">Deep talk</div></div>
          <div class="vibe-card" data-value="photo"><span class="vibe-icon">ğŸ“¸</span><div class="vibe-label">Chá»¥p áº£nh</div></div>
        </div>

        <div class="selected-count" id="vibeCount">ChÆ°a chá»n vibe nÃ o</div>
        <button class="btn primary btn-next" onclick="handleVibeNext()">Tiáº¿p theo â†’</button>
      </div>

      <!-- Q4: Date + Time -->
      <div class="question-card" id="q4">
        <div class="question-emoji">ğŸ“…</div>
        <h2 class="question-text">Khi nÃ o Ä‘i nÃ¨?</h2>
        <p class="question-hint">Chá»n ngÃ y + giá» em ráº£nh nháº¥t~</p>

        <div style="max-width:360px; margin:0 auto 24px; display:grid; gap:12px;">
          <input type="date" id="dateInput"
            style="width:100%; padding:16px; border-radius:14px; border:2px solid rgba(255,255,255,.2);
            background:rgba(0,0,0,.3); color:#fff; font-size:16px; text-align:center;">

          <input type="time" id="timeInput"
            style="width:100%; padding:16px; border-radius:14px; border:2px solid rgba(255,255,255,.2);
            background:rgba(0,0,0,.3); color:#fff; font-size:16px; text-align:center;">
        </div>

        <button class="btn primary" onclick="generatePlan()">ğŸ‰ Xem káº¿t quáº£ nÃ o!</button>
      </div>
    </div>
  </div>

  <!-- SCREEN 4: Result -->
  <div class="screen" id="screen4">
    <div class="result-container">
      <div class="result-card">
        <div class="result-header">
          <div class="result-emoji">ğŸŠ</div>
          <h2 class="result-title">Anh Ä‘Ã£ chá»‘t plan rá»“i!</h2>
          <p class="result-subtitle" id="resultSubtitle">KÃ¨o nÃ y cháº¯c cháº¯n vui láº¯m Ä‘Ã³~</p>
        </div>

        <div class="result-content">
          <div class="result-item">
            <div class="result-label">ğŸ“ Äá»‹a Ä‘iá»ƒm</div>
            <div class="result-value" id="resultPlace">Äang táº£i...</div>
          </div>

          <div class="result-item">
            <div class="result-label">ğŸ“… Thá»i gian</div>
            <div class="result-value" id="resultTime">Äang táº£i...</div>
          </div>

          <div class="result-item">
            <div class="result-label">ğŸ’° NgÃ¢n sÃ¡ch dá»± kiáº¿n</div>
            <div class="result-value" id="resultBudget">Äang táº£i...</div>
          </div>

          <div class="result-item">
            <div class="result-label">ğŸ—ºï¸ Lá»‹ch trÃ¬nh gá»£i Ã½</div>
            <ul class="result-steps" id="resultSteps"><li>Äang táº£i...</li></ul>
          </div>

          <div class="result-item">
            <div class="result-label">ğŸ’¡ Ghi chÃº nhá»</div>
            <div class="result-value" id="resultNote" style="font-size:14px; font-weight:400; color:var(--muted);">Äang táº£i...</div>
          </div>
        </div>

        <div class="email-status" id="emailStatus"></div>

        <div class="result-actions" style="margin-top:10px;">
          <div style="
            text-align:center; width:100%;
            padding:12px 14px;
            border:1px solid rgba(255,255,255,.14);
            border-radius:14px;
            background: rgba(255,255,255,.06);
            color: var(--muted);
            font-size:14px;
          ">
            Cáº£m Æ¡n em ThÃ¹y Ä‘Ã£ chá»n nhaaaaa ğŸ’—
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const BACKEND_URL = ""; // same-origin

    const userChoices = {
      email: null,
      cafe: null,
      budget: null,
      vibes: [],
      date: null,
      time: null
    };

    let currentQuestion = 1;

    // ===== Screens =====
    function nextScreen(which){
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

      if (which === "email") return $('screenEmail').classList.add('active');
      if (which === 2) return $('screen2').classList.add('active');
      if (which === 3) {
        $('screen3').classList.add('active');
        initDateTime();
        return;
      }
      if (which === 4) return $('screen4').classList.add('active');

      $('screen1').classList.add('active');
    }

    function nextQuestion(num){
      $('q' + currentQuestion).classList.remove('active');
      $('dot' + currentQuestion).classList.remove('active');
      $('dot' + currentQuestion).classList.add('done');

      currentQuestion = num;
      $('q' + num).classList.add('active');
      $('dot' + num).classList.add('active');
    }

    function saveEmailAndGo(){
      const email = $('receiverEmail').value.trim();
      const status = $('emailGateStatus');

      if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
        status.textContent = "âš ï¸ Nháº­p email há»£p lá»‡ nha (vd: abc@gmail.com)";
        status.style.color = "#ff4d9d";
        return;
      }

      userChoices.email = email;
      status.textContent = "âœ… Okiee! Giá» chá»n quÃ¡n nÃ¨~";
      status.style.color = "#2de2e6";

      setTimeout(() => nextScreen(3), 350);
    }

    // ===== Q1: Cafe =====
    const cafeCards = document.querySelectorAll('#cafeOptions .option-card');
    cafeCards.forEach(card => {
      card.addEventListener('click', () => {
        cafeCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        userChoices.cafe = card.dataset.value;
        setTimeout(() => nextQuestion(2), 350);
      });
    });

    // ===== Q2: Budget =====
    const budgetCards = document.querySelectorAll('#budgetOptions .option-card');
    budgetCards.forEach(card => {
      card.addEventListener('click', () => {
        budgetCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        userChoices.budget = card.dataset.value;
        setTimeout(() => nextQuestion(3), 350);
      });
    });

    // ===== Q3: Vibes =====
    const vibeCards = document.querySelectorAll('#vibeOptions .vibe-card');
    vibeCards.forEach(card => {
      card.addEventListener('click', () => {
        const value = card.dataset.value;

        if (card.classList.contains('selected')) {
          card.classList.remove('selected');
          userChoices.vibes = userChoices.vibes.filter(v => v !== value);
        } else {
          if (userChoices.vibes.length < 3) {
            card.classList.add('selected');
            userChoices.vibes.push(value);
          }
        }
        updateVibeCount();
      });
    });

    function updateVibeCount(){
      const c = userChoices.vibes.length;
      if (c === 0) $('vibeCount').textContent = "ChÆ°a chá»n vibe nÃ o";
      else $('vibeCount').textContent = `ÄÃ£ chá»n ${c} vibe${c>1?'s':''}`;
    }

    function handleVibeNext(){
      const c = userChoices.vibes.length;
      if (c === 0){
        $('vibeCount').textContent = "âš ï¸ Chá»n Ã­t nháº¥t 1 vibe nha!";
        $('vibeCount').style.color = "#ff4d9d";
        setTimeout(() => { $('vibeCount').style.color = ""; updateVibeCount(); }, 1400);
        return;
      }
      nextQuestion(4);
    }

    // ===== Date & Time =====
    function pad2(n){ return String(n).padStart(2, "0"); }
    function initDateTime(){
      const now = new Date();
      const isoDate = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
      $('dateInput').value = isoDate;
      userChoices.date = isoDate;

      // giá» máº·c Ä‘á»‹nh = giá» hiá»‡n táº¡i lÃ m trÃ²n 30'
      const copy = new Date(now);
      const mins = copy.getMinutes();
      const add = (30 - (mins % 30)) % 30;
      copy.setMinutes(mins + add);
      const isoTime = `${pad2(copy.getHours())}:${pad2(copy.getMinutes())}`;
      $('timeInput').value = isoTime;
      userChoices.time = isoTime;

      $('dateInput').onchange = (e) => userChoices.date = e.target.value;
      $('timeInput').onchange = (e) => userChoices.time = e.target.value;
    }

    function fmtDate(d){
      const days = ["Chá»§ nháº­t","Thá»© hai","Thá»© ba","Thá»© tÆ°","Thá»© nÄƒm","Thá»© sÃ¡u","Thá»© báº£y"];
      return `${days[d.getDay()]}, ${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    }

    function budgetLabel(b){
      if (b === "low") return "Tiáº¿t kiá»‡m (0â€“200k/ngÆ°á»i)";
      if (b === "mid") return "á»”n Ã¡p (200kâ€“800k/ngÆ°á»i)";
      if (b === "high") return "Tá»± thÆ°á»Ÿng (800k+/ngÆ°á»i)";
      return b || "";
    }

    function hashStr(s){
      let h = 2166136261;
      for (let i = 0; i < s.length; i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }

    // ===== Suggest =====
    const SUGGEST = [
      {
        cafe: "Mequilla Coffee",
        tags: ["cafe","walk","deep","photo","nature"],
        name: "Mequilla Coffee â†’ dáº¡o há»“ NghÄ©a TÃ¢n (talk chill)",
        location: "Mequilla Coffee + Há»“ NghÄ©a TÃ¢n",
        steps: [
          "Gáº·p nhau á»Ÿ Mequilla Coffee, gá»i mÃ³n nháº¹ (45â€“75')",
          "Ra há»“ NghÄ©a TÃ¢n Ä‘i dáº¡o 30â€“45' nÃ³i chuyá»‡n",
          "Ngá»“i gháº¿ Ä‘Ã¡/gÃ³c yÃªn tÄ©nh Ä‘á»ƒ â€˜deep talkâ€™ thÃªm 20â€“30' rá»“i vá»"
        ],
        timeHint:{ weekday:"18:00â€“21:00", weekend:"15:30â€“21:30" },
        cost:{ low:"60â€“120k/ng", mid:"120â€“250k/ng", high:"250k+/ng" }
      },
      {
        cafe: "Má»™c Coffee",
        tags: ["cafe","walk","deep","nature","photo"],
        name: "Má»™c Coffee â†’ dáº¡o há»“ NghÄ©a TÃ¢n (vibe nháº¹ nhÃ ng)",
        location: "Má»™c Coffee + Há»“ NghÄ©a TÃ¢n",
        steps: [
          "Ngá»“i Má»™c Coffee uá»‘ng cafe/Ä‘á»“ Ä‘Ã¡ xay (60â€“90')",
          "Äi bá»™ quanh há»“ NghÄ©a TÃ¢n, ká»ƒ chuyá»‡n tuáº§n nÃ y (30â€“45')",
          "Chá»¥p 1â€“2 táº¥m áº£nh ká»· niá»‡m rá»“i chá»‘t kÃ¨o láº§n sau"
        ],
        timeHint:{ weekday:"18:00â€“21:30", weekend:"14:30â€“21:30" },
        cost:{ low:"60â€“130k/ng", mid:"130â€“280k/ng", high:"280k+/ng" }
      },
      {
        cafe: "Taetna Tacos PhÃ¡p",
        tags: ["anvat","walk","cafe","photo"],
        name: "Taetna Tacos (PhÃ¡p) â†’ dáº¡o há»“ NghÄ©a TÃ¢n (Äƒn nháº¹ + Ä‘i bá»™)",
        location: "Taetna Tacos (PhÃ¡p) + Há»“ NghÄ©a TÃ¢n",
        steps: [
          "Ä‚n nháº¹ á»Ÿ Taetna Tacos (PhÃ¡p) (45â€“70')",
          "Ra há»“ NghÄ©a TÃ¢n Ä‘i dáº¡o 30â€“45' cho tiÃªu bá»›t â€˜noâ€™",
          "Ngá»“i nÃ³i chuyá»‡n thÃªm 20â€“30' (Æ°u tiÃªn chá»— thoÃ¡ng) rá»“i vá»"
        ],
        timeHint:{ weekday:"18:30â€“21:30", weekend:"16:00â€“22:00" },
        cost:{ low:"90â€“170k/ng", mid:"170â€“350k/ng", high:"350k+/ng" }
      },
    ];

    function pickSuggestion(){
      // Æ°u tiÃªn quÃ¡n user chá»n, rá»“i match vibe
      const cafe = userChoices.cafe;
      let pool = SUGGEST.filter(s => s.cafe === cafe);
      if (!pool.length) pool = [...SUGGEST];

      const match = (item) => userChoices.vibes.some(v => item.tags.includes(v));
      let pool2 = pool.filter(match);
      if (!pool2.length) pool2 = pool;

      const seed = hashStr((cafe||"") + "|" + userChoices.vibes.join(",") + "|" + userChoices.budget);
      const sorted = pool2
        .map((x, idx) => ({ x, k: (hashStr(x.name + idx) ^ seed) >>> 0 }))
        .sort((a,b) => a.k - b.k)
        .map(o => o.x);

      return sorted[0];
    }

    // ===== Send to backend =====
    let lastSentAt = 0;
    async function sendPlanToBackend(payload){
      const now = Date.now();
      if (now - lastSentAt < 2500) return; // chá»‘ng spam nhanh
      lastSentAt = now;

      const status = $('emailStatus');
      status.textContent = "â³ Äang gá»­i plan vá» email...";
      status.style.color = "";

      try{
        const res = await fetch(`${BACKEND_URL}/api/plan`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) throw new Error(data.message || `HTTP ${res.status}`);

        status.textContent = `âœ… Gá»­i xong! Check inbox/spam cá»§a em nhaaaaaa ğŸ’Œ`;
        status.style.color = "#2de2e6";
      } catch(e){
        console.error(e);
        status.textContent = "âš ï¸ Gá»­i lá»—i. Check backend/CORS/SMTP nha.";
        status.style.color = "#ff4d9d";
      }
    }

    // ===== Generate Plan =====
    function generatePlan(){
      const sug = pickSuggestion();
      if (!sug) return;

      if (!userChoices.email){
        // fallback cá»±c hiáº¿m náº¿u user refresh giá»¯a chá»«ng
        nextScreen("email");
        return;
      }
      if (!userChoices.cafe || !userChoices.budget || !userChoices.date || !userChoices.time){
        return;
      }

      const dateObj = new Date(userChoices.date + "T00:00:00");
      const weekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);

      const timeRange = weekend ? sug.timeHint.weekend : sug.timeHint.weekday;
      const money = userChoices.budget === "low" ? sug.cost.low :
                    (userChoices.budget === "mid" ? sug.cost.mid : sug.cost.high);

      const note =
        userChoices.vibes.includes("deep")
          ? "Gá»£i Ã½: há»i 3 cÃ¢u â€˜deep talkâ€™ nháº¹: tuáº§n nÃ y em vui nháº¥t lÃºc nÃ o? em muá»‘n Ä‘Æ°á»£c quan tÃ¢m theo cÃ¡ch nÃ o? Ä‘iá»u em mong á»Ÿ buá»•i háº¹n nÃ y?"
          : userChoices.vibes.includes("photo")
            ? "Tip: chá»n gÃ³c Ä‘Ã¨n vÃ ng trong quÃ¡n + ra há»“ lÃºc trá»i xuá»‘ng Ä‘á»ƒ áº£nh â€˜lá»¥i timâ€™ hÆ¡n."
            : "Giá»¯ lá»‹ch linh hoáº¡t, Æ°u tiÃªn tráº£i nghiá»‡m vÃ  nÃ³i chuyá»‡n cÃ¹ng nhau.";

      $('resultSubtitle').textContent = `${userChoices.cafe} â€¢ ${userChoices.vibes.join(", ") || "vibe chill"}`;
      $('resultPlace').textContent = `${sug.name} (${sug.location})`;
      $('resultTime').textContent = `${fmtDate(dateObj)} â€¢ ${userChoices.time} â€¢ (gá»£i Ã½ khung: ${timeRange})`;
      $('resultBudget').textContent = money;
      $('resultSteps').innerHTML = sug.steps.map(s => `<li>${s}</li>`).join("");
      $('resultNote').textContent = note;

      nextScreen(4);
      popConfetti();

      // Payload gá»­i backend (quan trá»ng)
      const payload = {
        to_email: userChoices.email,
        area: "Cáº§u Giáº¥y",
        budget: budgetLabel(userChoices.budget),
        vibes: userChoices.vibes.join(", "),
        date: userChoices.date,
        time: userChoices.time,
        place: `${sug.name} (${sug.location})`,
        timeText: `${fmtDate(dateObj)} â€¢ ${userChoices.time} â€¢ (gá»£i Ã½ khung: ${timeRange})`,
        money,
        steps: sug.steps.join(" | "),
        note,
      };

      sendPlanToBackend(payload);
    }

    // ===== Confetti =====
    function popConfetti(){
      const host = $('confetti');
      host.innerHTML = "";
      const n = 50;
      for (let i=0;i<n;i++){
        const p = document.createElement("i");
        p.style.left = (Math.random() * 100) + "vw";
        p.style.top = (-10 - Math.random()*30) + "px";
        p.style.animationDelay = (Math.random() * 0.15) + "s";
        p.style.animationDuration = (0.95 + Math.random() * 0.8) + "s";
        const hue = Math.floor(Math.random()*360);
        p.style.background = `hsl(${hue} 90% 60%)`;
        p.style.width = (6 + Math.random()*10) + "px";
        p.style.height = (8 + Math.random()*16) + "px";
        host.appendChild(p);
      }
      setTimeout(() => { host.innerHTML = ""; }, 1800);
    }

    // ===== Background canvas =====
    const canvas = $("bg");
    const ctx = canvas.getContext("2d", { alpha: true });

    let W = 0, H = 0, DPR = 1;
    function resize(){
      DPR = Math.min(window.devicePixelRatio || 1, 2);
      W = window.innerWidth;
      H = window.innerHeight;
      canvas.width = W * DPR;
      canvas.height = H * DPR;
      canvas.style.width = W + "px";
      canvas.style.height = H + "px";
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }
    window.addEventListener("resize", resize);
    resize();

    const particles = [];
    const PCOUNT = 60;
    function initParticles(){
      particles.length = 0;
      for (let i=0;i<PCOUNT;i++){
        particles.push({
          x: Math.random()*W,
          y: Math.random()*H,
          r: 1.2 + Math.random()*2.4,
          vx: -0.2 + Math.random()*0.4,
          vy: -0.2 + Math.random()*0.4,
          a: 0.15 + Math.random()*0.3
        });
      }
    }
    initParticles();

    function draw(){
      ctx.clearRect(0,0,W,H);
      for (const p of particles){
        p.x += p.vx;
        p.y += p.vy;
        if (p.x < -20) p.x = W + 20;
        if (p.x > W + 20) p.x = -20;
        if (p.y < -20) p.y = H + 20;
        if (p.y > H + 20) p.y = -20;

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fillStyle = `rgba(255,255,255,${p.a})`;
        ctx.fill();
      }

      for (let i = 0; i < particles.length; i++){
        for (let j = i + 1; j < particles.length; j++){
          const a = particles[i], b = particles[j];
          const dx = a.x - b.x, dy = a.y - b.y;
          const dist = Math.hypot(dx, dy);
          if (dist < 100){
            const alpha = (1 - dist/100) * 0.14;
            ctx.strokeStyle = `rgba(255,255,255,${alpha})`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.stroke();
          }
        }
      }
      requestAnimationFrame(draw);
    }
    draw();
  </script>
</body>
</html>
